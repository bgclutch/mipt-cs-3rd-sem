/* Программа: Ожидание (блокировка) на семафоре */
#include <sys/types.h>
#include <sys/ipc.h>
#include <sys/sem.h>
#include <stdio.h>
#include <stdlib.h> /* Добавлено для exit() */

int main(int argc, char *argv[], char *envp[])
{
  int   semid;
  /* Имя файла для генерации ключа.
     ВНИМАНИЕ: Файл с таким именем должен существовать в текущей папке!
     Лучше назовите этот файл исходного кода "1_sem.c" или поменяйте имя здесь. */
  char pathname[]="1_sem.c";
  key_t key;
  struct sembuf mybuf;

  /* ftok - генерация уникального ключа IPC
     Параметры:
     1. pathname - путь к существующему файлу.
     2. 0 - id проекта (младшие 8 бит используются для смешивания с inode файла).
  */
  if((key = ftok(pathname, 0)) < 0) {
    printf("Can\'t generate key\n");
    exit(-1);
  }

  /* semget - создание или получение доступа к массиву семафоров
     Параметры:
     1. key - ключ IPC.
     2. 1 - количество семафоров в массиве (нам нужен один).
     3. 0666 | IPC_CREAT - права доступа (rw-rw-rw-) и флаг создания.
        !!! ИСПРАВЛЕНА ОШИБКА: было IPC_CREATE (неверно), стало IPC_CREAT (верно).
  */
  if((semid = semget(key, 1, 0666 | IPC_CREAT)) < 0)
  {
    printf("Can\'t create semaphore set\n");
    exit(-1);
  }

  /* Настройка операции над семафором */
  /* sem_num - индекс семафора в массиве (у нас всего 1, значит индекс 0) */
  mybuf.sem_num = 0;

  /* sem_op - операция.
     -1 : (P-операция / Wait) Попытка уменьшить значение семафора на 1.
          Если значение семафора > 0, оно уменьшается, и программа идет дальше.
          Если значение семафора == 0, программа "засыпает" (ждет), пока кто-то другой не увеличит его.
  */
  mybuf.sem_op  = -1;

  /* sem_flg - флаги операции.
     0 : Ожидающая операция (блокирующая). Если нельзя уменьшить, ждем.
     IPC_NOWAIT : Если нельзя уменьшить, вернуть ошибку сразу.
     SEM_UNDO : Отменить изменения, если процесс аварийно завершится.
  */
  mybuf.sem_flg = 0;

  printf("Waiting for semaphore...\n"); /* Добавлено для наглядности */

  /* semop - выполнение операции
     Параметры:
     1. semid - ID массива семафоров.
     2. &mybuf - указатель на структуру с описанием операции.
     3. 1 - количество операций (структур) в массиве mybuf.
  */
  if(semop(semid, &mybuf, 1) < 0)
  {
    printf("Can\'t wait for condition\n");
    exit(-1);
  }

  printf("The condition is present (Semaphore unlocked!)\n");
  return 0;
}